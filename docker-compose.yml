version: '3.8'

# ════════════════════════════════════════════════════════════
# DOCKER COMPOSE - DATUM TRAVELS (FULL DOCKERIZED)
# Stack completo de desarrollo con DOS bases de datos Oracle:
# - Oracle XE #1 (keycloak-db) → Para persistencia de Keycloak
# - Oracle XE #2 (app-db) → Para la aplicación principal
# - Keycloak → Servidor de autenticación
# 
# CONFIGURACIÓN DE TU INGENIERO: Adaptada para el proyecto
# ════════════════════════════════════════════════════════════
#
# Comandos útiles:
#   docker-compose up -d                    # Iniciar todos los servicios
#   docker-compose down                     # Detener servicios (mantiene datos)
#   docker-compose down -v                  # DESTRUIR TODO (datos incluidos)
#   docker-compose logs -f keycloak         # Ver logs de Keycloak
#   docker-compose logs -f app-db           # Ver logs de Oracle App
#   docker-compose ps                       # Ver estado
#   docker-compose restart keycloak         # Reiniciar Keycloak
#
# ════════════════════════════════════════════════════════════

services:
  
  # ──────────────────────────────────────────────────────────
  # ORACLE XE - Base de datos para KEYCLOAK
  # ──────────────────────────────────────────────────────────
  keycloak-db:
    image: gvenzl/oracle-xe:21-slim
    container_name: datum-keycloak-db
    restart: unless-stopped
    environment:
      ORACLE_PASSWORD: ${KC_DB_PASSWORD:-oracle_dev_pass}
      APP_USER: ${KC_DB_USER:-keycloak}
      APP_USER_PASSWORD: ${KC_DB_PASSWORD:-keycloak_dev_pass}
    volumes:
      - keycloak_db_data:/opt/oracle/oradata
    ports:
      - "${KC_DB_PORT:-1525}:1521"         # Puerto 1525 para no colisionar
    networks:
      - datum-network
    healthcheck:
      test: ["CMD-SHELL", "healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

  # ──────────────────────────────────────────────────────────
  # ORACLE XE - Base de datos de la APLICACIÓN
  # ──────────────────────────────────────────────────────────
  app-db:
    image: gvenzl/oracle-xe:21-slim
    container_name: datum-app-db
    restart: unless-stopped
    environment:
      ORACLE_PASSWORD: ${APP_DB_PASSWORD:-oracle_app_pass}
      APP_USER: ${APP_DB_USER:-datum_user}
      APP_USER_PASSWORD: ${APP_DB_PASSWORD:-datum2025}
    volumes:
      - app_db_data:/opt/oracle/oradata
      - ./BackEnd/scripts:/docker-entrypoint-initdb.d/startup
    ports:
      - "${APP_DB_PORT:-1521}:1521"        # Puerto 1521 (tu app se conecta aquí)
    networks:
      - datum-network
    healthcheck:
      test: ["CMD-SHELL", "healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

  # ──────────────────────────────────────────────────────────
  # KEYCLOAK - Servidor de autenticación
  # ──────────────────────────────────────────────────────────
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: datum-keycloak
    restart: unless-stopped
    command: start-dev
    environment:
      # Configuración de Base de Datos Oracle (keycloak-db)
      KC_DB: oracle
      KC_DB_URL: jdbc:oracle:thin:@//keycloak-db:1521/XEPDB1
      KC_DB_USERNAME: ${KC_DB_USER:-keycloak}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD:-keycloak_dev_pass}

      # Credenciales de administrador
      KEYCLOAK_ADMIN: ${KC_ADMIN_USER:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KC_ADMIN_PASSWORD:-admin123}

      # Configuración de desarrollo
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      KC_LOG_LEVEL: ${KC_LOG_LEVEL:-info}
      
    ports:
      - "${KC_PORT:-8180}:8080"            # Puerto 8180 para no colisionar con Quarkus
    depends_on:
      keycloak-db:
        condition: service_healthy
    networks:
      - datum-network
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

# ════════════════════════════════════════════════════════════
# VOLUMES - Persistencia de datos (¡NO borrar sin querer!)
# ════════════════════════════════════════════════════════════
volumes:
  keycloak_db_data:
    driver: local
    name: datum-keycloak-db-vol
  app_db_data:
    driver: local
    name: datum-app-db-vol

# ════════════════════════════════════════════════════════════
# NETWORKS - Red para comunicación entre contenedores
# ════════════════════════════════════════════════════════════
networks:
  datum-network:
    driver: bridge
    name: datum-dev-network

# ════════════════════════════════════════════════════════════
# NOTAS IMPORTANTES:
# ════════════════════════════════════════════════════════════
#
# 1. ORACLE XE #1 - KEYCLOAK-DB (Puerto 1525):
#    - Solo para uso interno de Keycloak
#    - Usuario: keycloak / keycloak_dev_pass
#    - Connection: jdbc:oracle:thin:@localhost:1525/XEPDB1
#    - Consumo: ~1.5GB RAM
#
# 2. ORACLE XE #2 - APP-DB (Puerto 1521):
#    - Base de datos de TU APLICACIÓN (Eventos, Gastos, Empleados, etc.)
#    - Usuario: datum_user / datum2025
#    - Connection: jdbc:oracle:thin:@localhost:1521/XEPDB1
#    - Script de inicialización: ./BackEnd/scripts/init-oracle.sql
#    - Consumo: ~1.5GB RAM
#
# 3. KEYCLOAK (Puerto 8180):
#    - Admin Console: http://localhost:8180
#    - Usuario admin: admin / admin123
#    - Consumo: ~500-700MB RAM
#
# 4. CAMBIO EN application.properties DE QUARKUS:
#    Tu Quarkus ahora se conecta al Oracle dockerizado:
#    
#    quarkus.datasource.jdbc.url=jdbc:oracle:thin:@localhost:1521/XEPDB1
#    quarkus.datasource.username=datum_user
#    quarkus.datasource.password=datum2025
#
# 5. PRIMER INICIO (demora ~2-3 minutos):
#    docker-compose up -d
#    docker-compose logs -f app-db          # Ver inicio de Oracle App
#    docker-compose logs -f keycloak-db     # Ver inicio de Oracle Keycloak
#    docker-compose logs -f keycloak        # Ver inicio de Keycloak
#
# 6. RECURSOS TOTALES:
#    - Oracle Keycloak: ~1.5GB RAM
#    - Oracle App: ~1.5GB RAM
#    - Keycloak: ~700MB RAM
#    - TOTAL: ~3.7GB RAM (asegúrate de tener al menos 8GB)
#
# 7. VENTAJAS vs POSTGRES + ORACLE LOCAL:
#    ✅ Todo dockerizado, portátil entre máquinas
#    ✅ Keycloak con Oracle (mejor para producción)
#    ✅ Un solo "docker-compose up" inicia todo
#    ✅ Fácil resetear datos con "docker-compose down -v"
#    ❌ Consume más RAM (~3.7GB vs ~800MB con Postgres)
#
# 8. VARIABLES DE ENTORNO (.env):
#    Puedes crear un archivo .env en la raíz del proyecto:
#    
#    KC_DB_PORT=1525
#    KC_DB_PASSWORD=keycloak_dev_pass
#    APP_DB_PORT=1521
#    APP_DB_PASSWORD=datum2025
#    KC_PORT=8180
#    KC_ADMIN_PASSWORD=admin123
#
# ════════════════════════════════════════════════════════════