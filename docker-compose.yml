services:
  # Oracle XE database for Keycloak persistence - DEV
  keycloak-db:
    image: gvenzl/oracle-xe:21-slim
    container_name: datum-keycloak-db-dev
    environment:
      ORACLE_PASSWORD: ${KC_DB_PASSWORD:-oracle_dev_pass}
      APP_USER: ${KC_DB_USER:-keycloak}
      APP_USER_PASSWORD: ${KC_DB_PASSWORD:-keycloak_dev_pass}
    volumes:
      - keycloak_db_data_dev:/opt/oracle/oradata
    ports:
      - "${KC_DB_PORT:-1525}:1521"
    networks:
      - datum-network-dev
    healthcheck:
      test: ["CMD-SHELL", "healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

  # Keycloak Identity Provider - DEV
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: datum-keycloak-dev
    command: start-dev
    environment:
      # Database configuration
      KC_DB: oracle
      KC_DB_URL: jdbc:oracle:thin:@//keycloak-db:1521/XEPDB1
      KC_DB_USERNAME: ${KC_DB_USER:-keycloak}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD:-keycloak_dev_pass}

      # Keycloak admin credentials
      KEYCLOAK_ADMIN: ${KC_ADMIN_USER:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KC_ADMIN_PASSWORD:-admin123}

      # Development settings
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      KC_LOG_LEVEL: ${KC_LOG_LEVEL:-info}
    ports:
      - "${KC_PORT:-8089}:8080"
    depends_on:
      keycloak-db:
        condition: service_healthy
    networks:
      - datum-network-dev
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

  # Quarkus Auth Microservice - DEV
  datum-auth-service:
    build:
      context: ..
      dockerfile: datum_AUTH/Dockerfile.dev
    container_name: datum-auth-microservice-dev
    environment:
      # Environment
      QUARKUS_PROFILE: dev
      APP_ENV: development

      # HTTP Configuration
      QUARKUS_HTTP_PORT: ${APP_PORT:-8085}

      # OIDC configuration pointing to Keycloak
      QUARKUS_OIDC_AUTH_SERVER_URL: http://keycloak:8080/realms/${KC_REALM:-datum-realm}
      QUARKUS_OIDC_CLIENT_ID: ${KC_CLIENT_ID:-datum-quarkus-client}
      QUARKUS_OIDC_CREDENTIALS_SECRET: ${KC_CLIENT_SECRET:-EhoEbzs4rlBXtnBH3QfCfbGq3ouPtO7L}
      QUARKUS_OIDC_TLS_VERIFICATION: none
      QUARKUS_OIDC_TOKEN_ISSUER: any

      # Rest Client Configuration
      QUARKUS_REST_CLIENT_KEYCLOAK_API_URL: http://keycloak:8080

      # CORS configuration for frontend
      QUARKUS_HTTP_CORS: true
      QUARKUS_HTTP_CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:4200}

      # Logging
      QUARKUS_LOG_LEVEL: ${APP_LOG_LEVEL:-DEBUG}
    ports:
      - "${APP_PORT:-8085}:${APP_PORT:-8085}"
    depends_on:
      keycloak:
        condition: service_healthy
    networks:
      - datum-network-dev
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${APP_PORT:-8085}/q/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - with-app

networks:
  datum-network-dev:
    driver: bridge
    name: datum-dev-network

volumes:
  keycloak_db_data_dev:
    name: datum-keycloak-db-dev